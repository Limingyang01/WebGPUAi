# 布丁离线AI助手 - 历史记录功能需求文档

## 1. 背景概述

### 1.1 项目简介
布丁离线AI助手是一个基于 WebGPU 的浏览器本地 AI 对话应用，使用 WebLLM 库在客户端运行大语言模型。

### 1.2 当前状态
- 所有对话数据仅存放在内存中（React state `messages`）
- 页面刷新后对话历史丢失
- 模型缓存使用 IndexedDB（`webllm-cache`）

### 1.3 需求目标
实现对话历史持久化存储功能，提升用户体验。

---

## 2. 功能需求

### 2.1 基础功能

#### 2.1.1 历史记录存储
| 功能 | 描述 |
|------|------|
| 自动保存 | 每次对话结束后自动保存到 IndexedDB |
| 手动保存 | 支持用户主动保存对话 |
| 存储内容 | 完整消息记录、模型信息、角色选择、时间戳 |

#### 2.1.2 历史记录列表
| 功能 | 描述 |
|------|------|
| 列表展示 | 显示所有保存的历史对话（侧边栏或抽屉） |
| 标题生成 | 自动提取对话首句作为标题 |
| 时间显示 | 显示对话创建/最后更新时间 |
| 预览功能 | 悬停显示对话摘要 |

#### 2.1.3 历史记录管理
| 功能 | 描述 |
|------|------|
| 加载历史 | 点击历史项加载对话内容 |
| 新建对话 | 清除当前对话，开始新对话 |
| 删除历史 | 删除单条或批量删除历史 |
| 重命名 | 支持自定义对话标题 |
| 搜索 | 支持按标题/内容搜索历史 |

### 2.2 高级功能

#### 2.2.1 对话导入导出
| 功能 | 描述 |
|------|------|
| 导出 JSON | 导出完整对话记录为 JSON 文件 |
| 导出 Markdown | 导出为 Markdown 格式（便于阅读） |
| 导入 JSON | 从 JSON 文件导入对话记录 |

#### 2.2.2 存储管理
| 功能 | 描述 |
|------|------|
| 存储统计 | 显示已用/可用存储空间 |
| 清理缓存 | 一键清理所有历史数据 |
| 自动清理 | 设置保留最近 N 条历史 |

---

## 3. 技术方案

### 3.1 数据存储结构

#### IndexedDB Schema
```
数据库: pudding-chat-db (版本号: 1)

对象存储: conversations
├── id: 自增主键
├── title: 对话标题
├── modelId: 使用的模型ID
├── roleId: 使用的角色ID
├── messages: 消息数组 [{role, content, timestamp}]
├── createdAt: 创建时间
├── updatedAt: 更新时间
└── tokenCount: token统计（可选）

对象存储: settings
├── key: 设置键名
└── value: 设置值
```

#### 消息数据结构
```typescript
interface Message {
    role: 'user' | 'assistant' | 'system';
    content: string;
    timestamp: number;
}

interface Conversation {
    id: number;
    title: string;
    modelId: string;
    roleId: string;
    messages: Message[];
    createdAt: number;
    updatedAt: number;
}
```

### 3.2 存储位置

| 数据类型 | 存储位置 | 键名 |
|---------|---------|------|
| 对话历史 | IndexedDB `puddding-chat-db` | `conversations` store |
| 模型缓存 | IndexedDB `webllm-cache` | `model-cache` store |
| 用户偏好 | localStorage | `pudding_settings` |

### 3.3 需要新增的代码模块

#### 3.3.1 IndexedDB 操作模块
```javascript
// 历史记录 CRUD 操作
- createConversation(conversation)
- getConversation(id)
- getAllConversations()
- updateConversation(id, data)
- deleteConversation(id)
- searchConversations(keyword)
```

#### 3.3.2 新增 React 组件
```javascript
// 历史记录面板
- ConversationList     // 历史列表
- ConversationItem     // 单条历史项
- ConversationDrawer   // 抽屉式面板

// 对话管理
- NewChatButton        // 新建对话按钮
- DeleteConfirmModal   // 删除确认弹窗
- ExportMenu           // 导出菜单
```

#### 3.3.3 需要修改的功能
| 位置 | 修改内容 |
|------|---------|
| `sendMessage()` | 对话结束后保存到 IndexedDB |
| `loadModel()` | 加载时检查是否有未保存对话 |
| `App` 组件 | 新增历史状态和方法 |
| UI 界面 | 新增历史记录入口和面板 |

---

## 4. UI 设计建议

### 4.1 布局调整

```
┌─────────────────────────────────────┐
│  [←] 布丁离线AI助手          [📚]  │
├──────────┬──────────────────────────┤
│          │                          │
│  历史记录 │      对话区域            │
│  面板     │                          │
│  (侧边/   │  ┌────────────────────┐ │
│   抽屉)   │  │                    │ │
│          │  │    消息气泡         │ │
│  ┌─────┐ │  │                    │ │
│  │💬 新的│ │  └────────────────────┘ │
│  │ 对话 │ │                          │
│  └─────┘ │  ┌────────────────────┐ │
│  ┌─────┐ │  │ [输入框...] [发送] │ │
│  │📅 今天│ │  └────────────────────┘ │
│  │ - xxx│ │                          │
│  └─────┘ │                          │
│  ┌─────┐ │                          │
│  │📅 昨天│ │                          │
│  │ - xxx│ │                          │
│  └─────┘ │                          │
└──────────┴──────────────────────────┘
```

### 4.2 交互流程

1. **新建对话**: 点击按钮 → 清空当前消息 → 新建空对话记录
2. **保存对话**: 对话结束自动保存 → 更新时间戳
3. **加载历史**: 点击历史项 → 加载对应消息 → 恢复模型/角色设置
4. **删除历史**: 右键/长按 → 确认删除 → 从 IndexedDB 移除

---

## 5. 开发优先级

### 第一期（P0）- 核心功能
- [ ] IndexedDB 历史记录存储模块
- [ ] 自动保存对话历史
- [ ] 历史记录列表展示
- [ ] 加载历史对话功能
- [ ] 新建对话功能
- [ ] 删除历史功能

### 第二期（P1）- 增强体验
- [ ] 对话标题自动生成
- [ ] 按时间分组显示
- [ ] 对话搜索功能
- [ ] 存储空间统计
- [ ] 导出 JSON/Markdown

### 第三期（P2）- 高级功能
- [ ] 对话导入
- [ ] 批量操作
- [ ] 自动清理策略
- [ ] 对话分享功能
- [ ] 多设备同步（需后端）

---

## 6. 风险与限制

| 风险 | 影响 | 应对措施 |
|------|------|---------|
| 存储空间限制 | IndexedDB 有限制 | 定期清理、提供统计 |
| 数据迁移困难 | 升级导致数据不兼容 | 版本号管理 |
| 大模型内存占用 | 对话历史过长影响性能 | 限制历史长度 |
| 浏览器兼容性 | 部分浏览器 IndexedDB 支持差 | 降级方案 |

---

## 7. 验收标准

- [ ] 对话关闭/刷新后历史不丢失
- [ ] 历史记录列表加载时间 < 1s
- [ ] 单个对话支持存储 1000+ 消息
- [ ] 支持导出 10MB 以上对话记录
- [ ] 存储空间可视化展示

---

# 布丁离线AI助手 - RAG 知识库功能需求文档

## 1. 背景概述

### 1.1 项目现状
- 基于 WebGPU 的浏览器端本地 AI 对话应用
- 使用 WebLLM 库运行大语言模型
- 已实现对话历史持久化（IndexedDB）
- 所有模型和数据都在客户端本地运行

### 1.2 RAG 功能目标
实现本地知识库功能，让 AI 能够基于用户上传的文档资料进行问答，提升回答的准确性和专业性。

---

## 2. 功能需求

### 2.1 知识库管理

| 功能 | 描述 | 优先级 |
|------|------|--------|
| 创建知识库 | 新建一个知识库集合（可命名） | P0 |
| 删除知识库 | 删除整个知识库及其所有文档 | P0 |
| 知识库列表 | 显示所有已创建的知识库 | P0 |
| 知识库重命名 | 修改知识库名称 | P1 |

### 2.2 文档管理

| 功能 | 描述 | 优先级 |
|------|------|--------|
| 文档上传 | 支持上传 TXT、MD、PDF 文件 | P0 |
| 文档列表 | 显示知识库中的所有文档 | P0 |
| 删除文档 | 从知识库中移除指定文档 | P0 |
| 文档预览 | 查看文档内容片段 | P1 |
| 文档解析进度 | 显示 PDF 等文件的解析进度 | P1 |

### 2.3 问答功能

| 功能 | 描述 | 优先级 |
|------|------|--------|
| 选择知识库问答 | 问答时指定使用的知识库 | P0 |
| 检索增强回答 | 将检索到的相关内容注入 Prompt | P0 |
| 显示引用来源 | 在回答中标注参考的文档片段 | P0 |
| 多知识库切换 | 支持在不同知识库间切换 | P1 |

### 2.4 知识库设置

| 功能 | 描述 | 优先级 |
|------|------|--------|
| 相似度阈值 | 设置检索结果的相关度阈值 | P1 |
| 检索数量 | 设置返回的最大相关片段数 | P1 |
| 分块大小 | 文档分块的大小配置 | P2 |

---

## 3. 技术方案

### 3.1 技术选型

由于是纯前端浏览器环境，选择轻量级方案：

| 模块 | 技术方案 | 说明 |
|------|----------|------|
| 文档解析 | 原生 FileReader + PDF.js | PDF 文件需要 PDF.js |
| 文本分块 | 自定义固定长度重叠分块 | 简单可靠 |
| 向量嵌入 | 使用小模型生成 Embedding | 或使用关键词匹配作为简化方案 |
| 向量存储 | IndexedDB | 存储文本块和向量 |
| 相似度检索 | 余弦相似度计算 / 关键词匹配 | 纯 JS 实现 |

### 3.2 数据结构设计

```javascript
// 知识库索引数据库
数据库: pudding-knowledge-db

对象存储: knowledgeBases
├── id: 自增主键
├── name: 知识库名称
├── description: 描述
├── createdAt: 创建时间
├── updatedAt: 更新时间
└── documentCount: 文档数量

对象存储: documents
├── id: 自增主键
├── knowledgeBaseId: 所属知识库 ID
├── name: 文档名称
├── type: 文档类型 (txt/md/pdf)
├── content: 原始文本内容
├── chunkCount: 分块数量
├── createdAt: 上传时间
└── status: 状态 (pending/processing/completed/error)

对象存储: chunks
├── id: 自增主键
├── documentId: 所属文档 ID
├── content: 分块文本内容
├── index: 分块索引
├── createdAt: 创建时间
```

---

## 4. 实施状态

### Phase 1: 基础架构 (已完成)
- [x] 创建知识库管理 IndexedDB 模块
- [x] 实现知识库 CRUD 操作
- [x] 实现文档上传和解析（TXT/MD）
- [x] 实现文本分块功能
- [x] UI：知识库列表和创建

### Phase 2: 检索功能 (已完成)
- [x] 实现基于关键词的文本检索
- [x] 实现 Prompt 增强逻辑
- [x] UI：知识库选择器
- [x] UI：引用来源展示

### Phase 3: PDF 支持 (待实现)
- [ ] 集成 PDF.js
- [ ] 实现 PDF 文本提取
- [ ] 解析进度显示

### Phase 4: 向量检索 (待实现)
- [ ] 集成轻量级 Embedding 模型
- [ ] 实现向量存储和相似度计算
- [ ] 优化检索效果

---

## 5. 验收标准

- [x] 可以创建、删除、重命名知识库
- [x] 可以上传 TXT/MD 文件并自动分块
- [x] 问答时能检索到相关文档内容
- [x] 回答中显示引用来源
- [x] 页面刷新后知识库数据不丢失
