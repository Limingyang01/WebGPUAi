# 布丁离线AI助手 - 历史记录功能需求文档

## 1. 背景概述

### 1.1 项目简介
布丁离线AI助手是一个基于 WebGPU 的浏览器本地 AI 对话应用，使用 WebLLM 库在客户端运行大语言模型。

### 1.2 当前状态
- 所有对话数据仅存放在内存中（React state `messages`）
- 页面刷新后对话历史丢失
- 模型缓存使用 IndexedDB（`webllm-cache`）

### 1.3 需求目标
实现对话历史持久化存储功能，提升用户体验。

---

## 2. 功能需求

### 2.1 基础功能

#### 2.1.1 历史记录存储
| 功能 | 描述 |
|------|------|
| 自动保存 | 每次对话结束后自动保存到 IndexedDB |
| 手动保存 | 支持用户主动保存对话 |
| 存储内容 | 完整消息记录、模型信息、角色选择、时间戳 |

#### 2.1.2 历史记录列表
| 功能 | 描述 |
|------|------|
| 列表展示 | 显示所有保存的历史对话（侧边栏或抽屉） |
| 标题生成 | 自动提取对话首句作为标题 |
| 时间显示 | 显示对话创建/最后更新时间 |
| 预览功能 | 悬停显示对话摘要 |

#### 2.1.3 历史记录管理
| 功能 | 描述 |
|------|------|
| 加载历史 | 点击历史项加载对话内容 |
| 新建对话 | 清除当前对话，开始新对话 |
| 删除历史 | 删除单条或批量删除历史 |
| 重命名 | 支持自定义对话标题 |
| 搜索 | 支持按标题/内容搜索历史 |

### 2.2 高级功能

#### 2.2.1 对话导入导出
| 功能 | 描述 |
|------|------|
| 导出 JSON | 导出完整对话记录为 JSON 文件 |
| 导出 Markdown | 导出为 Markdown 格式（便于阅读） |
| 导入 JSON | 从 JSON 文件导入对话记录 |

#### 2.2.2 存储管理
| 功能 | 描述 |
|------|------|
| 存储统计 | 显示已用/可用存储空间 |
| 清理缓存 | 一键清理所有历史数据 |
| 自动清理 | 设置保留最近 N 条历史 |

---

## 3. 技术方案

### 3.1 数据存储结构

#### IndexedDB Schema
```
数据库: pudding-chat-db (版本号: 1)

对象存储: conversations
├── id: 自增主键
├── title: 对话标题
├── modelId: 使用的模型ID
├── roleId: 使用的角色ID
├── messages: 消息数组 [{role, content, timestamp}]
├── createdAt: 创建时间
├── updatedAt: 更新时间
└── tokenCount: token统计（可选）

对象存储: settings
├── key: 设置键名
└── value: 设置值
```

#### 消息数据结构
```typescript
interface Message {
    role: 'user' | 'assistant' | 'system';
    content: string;
    timestamp: number;
}

interface Conversation {
    id: number;
    title: string;
    modelId: string;
    roleId: string;
    messages: Message[];
    createdAt: number;
    updatedAt: number;
}
```

### 3.2 存储位置

| 数据类型 | 存储位置 | 键名 |
|---------|---------|------|
| 对话历史 | IndexedDB `puddding-chat-db` | `conversations` store |
| 模型缓存 | IndexedDB `webllm-cache` | `model-cache` store |
| 用户偏好 | localStorage | `pudding_settings` |

### 3.3 需要新增的代码模块

#### 3.3.1 IndexedDB 操作模块
```javascript
// 历史记录 CRUD 操作
- createConversation(conversation)
- getConversation(id)
- getAllConversations()
- updateConversation(id, data)
- deleteConversation(id)
- searchConversations(keyword)
```

#### 3.3.2 新增 React 组件
```javascript
// 历史记录面板
- ConversationList     // 历史列表
- ConversationItem     // 单条历史项
- ConversationDrawer   // 抽屉式面板

// 对话管理
- NewChatButton        // 新建对话按钮
- DeleteConfirmModal   // 删除确认弹窗
- ExportMenu           // 导出菜单
```

#### 3.3.3 需要修改的功能
| 位置 | 修改内容 |
|------|---------|
| `sendMessage()` | 对话结束后保存到 IndexedDB |
| `loadModel()` | 加载时检查是否有未保存对话 |
| `App` 组件 | 新增历史状态和方法 |
| UI 界面 | 新增历史记录入口和面板 |

---

## 4. UI 设计建议

### 4.1 布局调整

```
┌─────────────────────────────────────┐
│  [←] 布丁离线AI助手          [📚]  │
├──────────┬──────────────────────────┤
│          │                          │
│  历史记录 │      对话区域            │
│  面板     │                          │
│  (侧边/   │  ┌────────────────────┐ │
│   抽屉)   │  │                    │ │
│          │  │    消息气泡         │ │
│  ┌─────┐ │  │                    │ │
│  │💬 新的│ │  └────────────────────┘ │
│  │ 对话 │ │                          │
│  └─────┘ │  ┌────────────────────┐ │
│  ┌─────┐ │  │ [输入框...] [发送] │ │
│  │📅 今天│ │  └────────────────────┘ │
│  │ - xxx│ │                          │
│  └─────┘ │                          │
│  ┌─────┐ │                          │
│  │📅 昨天│ │                          │
│  │ - xxx│ │                          │
│  └─────┘ │                          │
└──────────┴──────────────────────────┘
```

### 4.2 交互流程

1. **新建对话**: 点击按钮 → 清空当前消息 → 新建空对话记录
2. **保存对话**: 对话结束自动保存 → 更新时间戳
3. **加载历史**: 点击历史项 → 加载对应消息 → 恢复模型/角色设置
4. **删除历史**: 右键/长按 → 确认删除 → 从 IndexedDB 移除

---

## 5. 开发优先级

### 第一期（P0）- 核心功能
- [ ] IndexedDB 历史记录存储模块
- [ ] 自动保存对话历史
- [ ] 历史记录列表展示
- [ ] 加载历史对话功能
- [ ] 新建对话功能
- [ ] 删除历史功能

### 第二期（P1）- 增强体验
- [ ] 对话标题自动生成
- [ ] 按时间分组显示
- [ ] 对话搜索功能
- [ ] 存储空间统计
- [ ] 导出 JSON/Markdown

### 第三期（P2）- 高级功能
- [ ] 对话导入
- [ ] 批量操作
- [ ] 自动清理策略
- [ ] 对话分享功能
- [ ] 多设备同步（需后端）

---

## 6. 风险与限制

| 风险 | 影响 | 应对措施 |
|------|------|---------|
| 存储空间限制 | IndexedDB 有限制 | 定期清理、提供统计 |
| 数据迁移困难 | 升级导致数据不兼容 | 版本号管理 |
| 大模型内存占用 | 对话历史过长影响性能 | 限制历史长度 |
| 浏览器兼容性 | 部分浏览器 IndexedDB 支持差 | 降级方案 |

---

## 7. 验收标准

- [ ] 对话关闭/刷新后历史不丢失
- [ ] 历史记录列表加载时间 < 1s
- [ ] 单个对话支持存储 1000+ 消息
- [ ] 支持导出 10MB 以上对话记录
- [ ] 存储空间可视化展示
